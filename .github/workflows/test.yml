name: Build and Test

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Download Pre-built Dependencies
      shell: powershell
      run: |
        Write-Host "Downloading pre-built dependencies from GitHub Release..." -ForegroundColor Cyan
        
        $depsUrl = "https://github.com/${{ github.repository }}/releases/download/deps-v1/Dependencies-Windows-x64-latest.zip"
        $depsZip = "Dependencies.zip"
        
        $ProgressPreference = 'SilentlyContinue'
        Invoke-WebRequest -Uri $depsUrl -OutFile $depsZip
        Write-Host "[OK] Downloaded dependencies package" -ForegroundColor Green
        
        Write-Host "Extracting dependencies..." -ForegroundColor Cyan
        Expand-Archive -Path $depsZip -DestinationPath "Dependencies" -Force
        Remove-Item $depsZip
        Write-Host "[OK] Dependencies ready" -ForegroundColor Green

    - name: Restore Dependencies
      run: dotnet restore AnimeFlow/AnimeFlow.csproj

    - name: Build Debug
      run: dotnet build AnimeFlow/AnimeFlow.csproj --configuration Debug --no-restore

    - name: Build Release
      run: dotnet build AnimeFlow/AnimeFlow.csproj --configuration Release --no-restore
      
    - name: Check Dependencies
      shell: powershell
      run: |
        Write-Host "`n=== Dependency Check ===" -ForegroundColor Cyan
        $depsPath = "Dependencies"
        if (Test-Path $depsPath) {
          Write-Host "[OK] Dependencies folder exists" -ForegroundColor Green
          
          $checks = @(
            @{ Path = "mpv\libmpv-2.dll"; Name = "mpv library" },
            @{ Path = "mpv\mpv.exe"; Name = "mpv player" },
            @{ Path = "tools\yt-dlp.exe"; Name = "yt-dlp" },
            @{ Path = "rife\rife-ncnn-vulkan.exe"; Name = "RIFE standalone" },
            @{ Path = "models\rife-v4.6\flownet.bin"; Name = "RIFE models" },
            @{ Path = "vapoursynth\VapourSynth.dll"; Name = "VapourSynth" },
            @{ Path = "vapoursynth\vapoursynth64\plugins\VIVTC.dll"; Name = "VIVTC plugin" }
          )
          
          $allOk = $true
          foreach ($check in $checks) {
            $fullPath = Join-Path $depsPath $check.Path
            if (Test-Path $fullPath) {
              Write-Host "  [OK] $($check.Name)" -ForegroundColor Green
            } else {
              Write-Host "  [MISSING] $($check.Name)" -ForegroundColor Red
              $allOk = $false
            }
          }
          
          if (-not $allOk) {
            Write-Host "`n[WARNING] Some dependencies are missing!" -ForegroundColor Yellow
            exit 1
          }
          
          Write-Host "`n[OK] All dependencies verified" -ForegroundColor Green
        } else {
          Write-Host "[ERROR] Dependencies folder not found!" -ForegroundColor Red
          exit 1
        }
